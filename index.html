<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI ë…ì„œÂ·í† ë¡ Â·ê¸€ì“°ê¸° ìˆ˜ì—…</title>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; background:#f5f6f8; margin:0; }
    header { background:#2563eb; color:#fff; padding:16px; font-size:20px; font-weight:700; }
    .container { max-width:900px; margin:24px auto; background:#fff; border-radius:12px; padding:20px; box-shadow:0 8px 20px rgba(0,0,0,.08); }
    .row { margin-bottom:12px; }
    input, textarea { width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; }
    button { padding:10px 16px; border-radius:8px; border:none; background:#2563eb; color:#fff; font-weight:600; cursor:pointer; }
    button:disabled { background:#94a3b8; }
    .chat { margin-top:16px; }
    .bubble { padding:12px 16px; border-radius:12px; margin-bottom:12px; line-height:1.5; }
    .ai { background:#eef2ff; }
    .user { background:#2563eb; color:#fff; margin-left:auto; }
    .system { background:#e5e7eb; font-size:14px; }
  </style>
</head>
<body>

<header>AI ë…ì„œÂ·í† ë¡ Â·ê¸€ì“°ê¸° ìˆ˜ì—…</header>

<div class="container">

  <!-- í•™ìƒ ì •ë³´ ì…ë ¥ -->
  <div id="student-info">
    <div class="row"><input id="classNum" placeholder="ë°˜"></div>
    <div class="row"><input id="studentNum" placeholder="ë²ˆí˜¸"></div>
    <div class="row"><input id="studentName" placeholder="ì´ë¦„"></div>
    <button onclick="startActivity()">í™œë™ ì‹œì‘</button>
  </div>

  <!-- ìˆ˜ì—… ì˜ì—­ -->
  <div id="activity" style="display:none;">
    <h3 id="stepTitle">[1ë‹¨ê³„] ë‚˜ì˜ ìš”ì•½ ì‘ì„±</h3>

    <div class="chat" id="chat"></div>

    <div class="row">
      <textarea id="userInput" rows="3" placeholder="ìƒê°ì´ë‚˜ ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    </div>
    <button id="sendBtn">ì „ì†¡</button>
    <button onclick="downloadTxt()">ğŸ“„ í™œë™ì§€ ë‹¤ìš´ë¡œë“œ</button>
  </div>

</div>

<script>
/* ===== Cloudflare Worker í”„ë¡ì‹œ ===== */
const AI_PROXY_URL = "https://weathered-queen-92c0.eduartclass.workers.dev";

/* ===== ìƒíƒœ ===== */
let student = {};
let currentStep = 1;
let isLoading = false;
let activityLog = [];

const steps = {
  1: "ë‚˜ì˜ ìš”ì•½ ì‘ì„±",
  2: "AI ìš”ì•½ê³¼ ë¹„êµ",
  3: "ì°¨ì´ì  ë¶„ì„",
  4: "ê°œì„ ëœ ê¸€ ë‹¤ì‹œ ì“°ê¸°"
};

/* ===== UI ===== */
const chatEl = document.getElementById("chat");
const sendBtn = document.getElementById("sendBtn");
const inputEl = document.getElementById("userInput");
const stepTitle = document.getElementById("stepTitle");

function addBubble(text, type) {
  const div = document.createElement("div");
  div.className = `bubble ${type}`;
  div.textContent = text;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function addLog(role, text) {
  const time = new Date().toLocaleString();
  activityLog.push(`[${time}] ${role}: ${text}`);
}

/* ===== ì‹œì‘ ===== */
function startActivity() {
  student.classNum = classNum.value;
  student.studentNum = studentNum.value;
  student.name = studentName.value;

  if (!student.name) {
    alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  document.getElementById("student-info").style.display = "none";
  document.getElementById("activity").style.display = "block";

  addLog("ì‹œìŠ¤í…œ", `í•™ìƒ: ${student.classNum}ë°˜ ${student.studentNum}ë²ˆ ${student.name}`);
  addBubble(`${student.name} í•™ìƒ, í™œë™ì„ ì‹œì‘í•©ë‹ˆë‹¤.`, "system");
}

/* ===== AI í˜¸ì¶œ ===== */
async function callAI(prompt) {
  isLoading = true;
  sendBtn.disabled = true;
  addBubble("AIê°€ ì‘ë‹µì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...", "ai");

  try {
    const response = await fetch(AI_PROXY_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }]
      })
    });

    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "ì‘ë‹µ ì˜¤ë¥˜";

  } catch (e) {
    return "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
  } finally {
    isLoading = false;
    sendBtn.disabled = false;
  }
}

/* ===== ì „ì†¡ ===== */
sendBtn.addEventListener("click", async () => {
  const text = inputEl.value.trim();
  if (!text || isLoading) return;

  addBubble(text, "user");
  addLog(`STEP ${currentStep} (${steps[currentStep]})`, text);
  inputEl.value = "";

  const aiText = await callAI(
    `${student.name} í•™ìƒì˜ ê¸€ì…ë‹ˆë‹¤:\n${text}\nì¹œì ˆí•œ í”¼ë“œë°±ì„ ì£¼ì„¸ìš”.`
  );

  addBubble(aiText, "ai");
  addLog("AI", aiText);

  if (currentStep < 4) {
    currentStep++;
    stepTitle.textContent = `[${currentStep}ë‹¨ê³„] ${steps[currentStep]}`;
  } else {
    addBubble("í™œë™ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í™œë™ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.", "system");
  }
});

/* ===== TXT ë‹¤ìš´ë¡œë“œ ===== */
function downloadTxt() {
  const blob = new Blob([activityLog.join("\n\n")], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "AI_ë…ì„œí† ë¡ _í™œë™ì§€.txt";
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
